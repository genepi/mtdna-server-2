---
title: "mtDNA-Server 2"
output:
  #rmdformats::robobook:
  #  self_contained: true
  #  thumbnails: false
  #  lightbox: true
  #  gallery: false
  #  highlight: tango
  flexdashboard::flex_dashboard:
    orientation: rows
params:
  haplogroups: ../tests/data/report2/haplogroups.txt
  haplocheck: ../tests/data/report2/haplocheck.txt
  variants:  ../tests/data/report2/variants_ann.txt
  statistics:  ../tests/data/report2/sample_statistics.txt
---

```{r setup, include=FALSE}
library(ggplot2)
library(DT)
library(tidyverse)
library(data.table)
library(plotly)
library(flexdashboard)

knitr::opts_chunk$set(echo = FALSE)
```

```{r echo=FALSE, results='asis'}

variants <- read.delim(params$variants)
contamination <- read.delim(params$haplocheck)
haplogroups <- read.delim(params$haplogroups)
statistics <- read.delim(params$statistics)
```


# Samples

Row
-----------------------------------------------------------------------

### Number of Samples

```{r}
valueBox(nrow(haplogroups), icon = "fa-users")
```

### Excluded Samples

```{r}
valueBox(-1, icon = "fa-comments")
```

### Samples with Bad Quality

```{r}
valueBox(-1, icon = "fa-comments")
```


### Contaminated samples

```{r}
valueBox(-1, icon = "fa-comments")
```



Row
-------------------------------------
    
    
### Summary

```{r echo=FALSE, results='asis'}

statTable<-spread(statistics, key = Parameter, value = Value)
statTable$MeanCoverage<-as.numeric(statTable$MeanDepth)
statTable$MeanBaseQuality<-as.numeric(statTable$MeanBaseQuality)

variantCount<-data.table(t(table(variants$ID)))
variantCount$SampleID<-sub('\\.bam$', '', variantCount$V2)
contamination$SampleID<-sub('\\.bam$', '', contamination$Sample) 
haplogroups$SampleNID<-sub('\\.bam$', '', haplogroups$SampleID) 

statsTableMerged<-merge(statTable, contamination, by.x="Sample", by.y="SampleID")
statsTableMergedVariant<-merge(statsTableMerged, variantCount, by.x="Sample", by.y="SampleID")
statsTableMergedVariantHaplo<-merge(statsTableMergedVariant, haplogroups, by.x="Sample", by.y="SampleNID")

statsTableMergedVariantHaplo %>%
  select("Sample", "CoveragePercentage", "CoveredBases", "MeanBaseQuality", "MeanDepth", "MeanMapQuality") %>%
datatable()
```

Row
-------------------------------------
    

### Mean Coverage per sample

```{r echo=FALSE, results='asis'}
ggplotly(
  ggplot(statTable) +
    geom_col(aes(x=Sample, y=MeanCoverage), alpha=0.7) +
    theme(axis.text.x=element_text(angle=+90)) + 
    xlab("Samples") +
    ylab("Mean Coverage")
)
```

### Mean Base Quality per sample

```{r echo=FALSE, results='asis'}
ggplotly(
  ggplot(statTable) +
    geom_col(aes(x=Sample, y=MeanBaseQuality), alpha=0.7) +
    theme(axis.text.x=element_text(angle=+90)) + 
    geom_hline(yintercept=20, color="red", linetype="dashed") +
    xlab("Samples") +
    ylab("NMean Base Quality")
)
```



# Contamination

- Contaminated samples: `r nrow(haplogroups %>% mutate("Contamination_Status" = "Contamination.Status") %>% filter(Contamination_Status == "YES"))` / `r nrow(haplogroups)`

```{r echo=FALSE, results='asis'}
statsTableMergedVariantHaplo %>%
  select("Sample", "Contamination.Status", "Contamination.Level") %>%
  rename("Contamination_Status" = "Contamination.Status") %>% filter(Contamination_Status == "YES") %>%
datatable()
```

---

# Variants


### Summary

Table with sample name, number of variants,

```{r echo=FALSE, results='asis'}
statsTableMergedVariantHaplo %>%
  select("Sample", "N") %>%
datatable()
```

### Shared Variants


---

# Heteroplasmies


### Summary

Table with sample name, number of Heteroplasmies,

### Shared Heteroplasmies

---


# Haplogroups


Row
-------------------------------------

### Summary

```{r echo=FALSE, results='asis'}
statsTableMergedVariantHaplo %>%
  select("Sample", "Haplogroup","Quality") %>%
datatable()
```

Row
-------------------------------------

### Quality per Sample

```{r echo=FALSE, results='asis'}
ggplotly(
  ggplot(haplogroups, aes(y=Quality, x=SampleID)) + geom_col(alpha=0.7)   + geom_hline(yintercept=0.90, color="green", linetype="dashed") + geom_hline(yintercept=0.80, color="orange", linetype="dashed") + geom_hline(yintercept=0.70, color="red", linetype="dashed") + theme_minimal() + theme(axis.text.x=element_text(angle=+90))
)
```



---

# About

### Software versions

table

### Workflow parameters

table

### About this report

This report was produced using mtDNA-Server 2. link...