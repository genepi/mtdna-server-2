---
title: "mtDNA-Server 2"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
params:
  haplogroups: ../tests/data/report/haplogroups.txt
  haplocheck: ../tests/data/report/haplocheck.txt
  variants:  ../tests/data/report/variants_ann.txt
  statistics:  ../tests/data/report/sample_statistics.txt
  mapping:  ../tests/data/report/sample_mappings.txt  
  excluded_samples:  ../tests/data/report/excluded_samples.txt
  pipeline_parameters:  ../tests/data/report/params.txt  
---

```{r setup, include=FALSE}


MIN_COVERAGE_PERCENTAGE = 90;
MIN_MEAN_BASE_QUALITY = 15;
MIN_MEAN_DEPTH = 50

library(ggplot2)
library(DT)
library(tidyverse)
library(data.table)
library(plotly)
library(flexdashboard)
library(knitr)

knitr::opts_chunk$set(echo = FALSE)
```

```{r echo=FALSE, results='asis'}

variants <- read.delim(params$variants)
contamination <- read.delim(params$haplocheck)
haplogroups <- read.delim(params$haplogroups)
statistics <- read.delim(params$statistics)
pipeline_params <- read.delim(params$pipeline_parameters)

excluded_samples <- try(read.delim(params$excluded_samples, header = FALSE, ))
if(inherits(excluded_samples, "try-error")) {
  excluded_samples = data.frame(V1=c())
}


mapping <- read.delim(params$mapping)
mapping <- mapping %>%
  rename(Sample_Label = Sample)
mapping <- mapping %>%
  mutate(
    qc = case_when(
        Filename %in% excluded_samples$V1 ~ "FAILED",
        TRUE ~ "PASSED"
      )
  )

statistics<-spread(statistics, key = Parameter, value = Value)
statistics$MeanCoverage<-as.numeric(statistics$MeanDepth)
statistics$MeanBaseQuality<-as.numeric(statistics$MeanBaseQuality)
statistics<-merge(statistics, mapping, by.x="Sample", by.y="Filename")



haplogroups<-merge(haplogroups, mapping, by.x="SampleID", by.y="Filename") %>% arrange(Sample_Label)
contamination<-merge(contamination, mapping, by.x="Sample", by.y="Filename") %>% arrange(Sample_Label)

variants_count<-data.table(t(table(variants$ID)))
variants_count<-merge(variants_count, mapping, by.x="V2", by.y="Filename") %>% arrange(Sample_Label)

variants<-merge(variants, mapping, by.x="ID", by.y="Filename") %>% arrange(Sample_Label)

#statsTableMerged<-merge(statTable, contamination, by.x="Sample", by.y="SampleID")
#statsTableMergedVariant<-merge(statsTableMerged, variantCount, by.x="Sample", by.y="SampleID")
#statsTableMergedVariantHaplo<-merge(statsTableMergedVariant, haplogroups, by.x="Sample", by.y="SampleNID")

#statsTableMergedVariantHaplo <- statsTableMergedVariantHaplo %>% arrange(Sample)

contaminated_samples = contamination %>%
  mutate("Contamination_Status" = "Contamination.Status") %>%
  filter(Contamination_Status == "YES");


```


# Samples

Row
-----------------------------------------------------------------------

### Number of Samples

```{r}
valueBox(nrow(statistics), icon = "fa-users")
```

### Excluded Samples

```{r}
valueBox(nrow(excluded_samples), icon = "fa-filter")
```

### Samples with Bad Quality

```{r}
valueBox(-1, icon = "fa-exclamation")
```


### Contaminated Samples

```{r}
valueBox(nrow(contaminated_samples), icon = "fa-flask")
```



Row
-------------------------------------
    
    
### Summary  {data-width=750}

```{r echo=FALSE, results='asis'}

colors <- c("#28a745", "#dc3545")
names(colors) <- c("PASSED", "FAILED")

statistics %>%
  select("Sample_Label", "MeanDepth", "CoveragePercentage", "CoveredBases", "MeanBaseQuality", "MeanMapQuality", "qc") %>%
  datatable(
    colnames=c("Sample", "Mean Coverage", "Covered Bases (%)", "Covered Bases", "Mean Base Quality", "Mean Mapping Quality", "QC"),
    options = list(
      bPaginate = FALSE
    )
  ) %>% 
  formatStyle(
    'qc',
    backgroundColor = styleEqual(c("FAILED", "PASSED"), colors),
    color = 'white'
  )
```


### Workflow parameters and Software versions {data-width=250}

```{r echo=FALSE, results='asis'}
pipeline_params %>%
  kable()
```

Row
-------------------------------------
    

### Mean Coverage per sample

```{r echo=FALSE, results='asis'}

ggplotly(
  ggplot(statistics) +
    geom_col(aes(x=Sample_Label, y=MeanCoverage, fill=qc)) +
    theme(axis.text.x=element_text(angle=+90)) + 
    geom_hline(yintercept=MIN_MEAN_DEPTH, color="black", linetype="dashed") +
    scale_fill_manual(values=colors) +
    xlab("Samples") +
    ylab("Mean Coverage") +
    labs(fill = "")
)
```

### Mean Base Quality per sample

```{r echo=FALSE, results='asis'}
ggplotly(
  ggplot(statistics) +
    geom_col(aes(x=Sample_Label, y=MeanBaseQuality, fill=qc)) +
    theme(axis.text.x=element_text(angle=+90)) + 
    geom_hline(yintercept=MIN_MEAN_BASE_QUALITY, color="black", linetype="dashed") +
    scale_fill_manual(values=colors) +
    xlab("Samples") +
    ylab("Mean Base Quality") +
    labs(fill = "")
)
```



# Contamination

```{r echo=FALSE, results='asis'}
contaminated_samples %>%
  select("Sample_Label", "Contamination_Status", "Contamination.Level") %>%
  datatable(
    colnames=c("Sample", "Contamination","Level"),
    options = list(
      bPaginate = FALSE
    )
  )
```

---

# Variants and Heteroplasmies

Row
-------------------------------------

### Summary

```{r echo=FALSE, results='asis'}
variants_count %>%
  select("Sample_Label", "N") %>%
  datatable(
    colnames=c("Sample", "Number of Variants"),
    options = list(
      bPaginate = FALSE
    )
  )
```

Row
-------------------------------------

### Common Variants and Hetereoplasmies


```{r echo=FALSE, results='asis'}
summary_data <- aggregate(  Sample_Label ~ Pos + Type , data = variants, FUN = length)
summary_data <- summary_data %>% filter(Sample_Label >= 2)
summary_data <- summary_data %>% mutate(
  label = case_when(
    Type == 1 ~ "Variant",
    Type == 2 ~ "Heteroplasmy",
    TRUE ~ "Unknown"
  )
)
summary_data$AF<-summary_data$Sample_Label / max(length(unique(variants$Sample_Label)))
ggplotly(
  ggplot(summary_data, aes(x = Pos, y = AF, color=label)) +
    geom_point() +
    xlab("Position") +
    ylab("Allele Frequency") +
    labs(color = "Type")
)
```

---


# Haplogroups


Row
-------------------------------------

### Summary

```{r echo=FALSE, results='asis'}
haplogroups %>%
  select("Sample_Label", "Haplogroup", "Quality") %>%
  datatable(
    colnames=c("Sample", "Haplogroup", "Quality"),
    options = list(
      bPaginate = FALSE
    )
  )
```

Row
-------------------------------------

### Quality per Sample

```{r echo=FALSE, results='asis'}
ggplotly(
  ggplot(haplogroups) +
    geom_col(aes(y=Quality, x=Sample_Label), alpha=0.7) +
    geom_hline(yintercept=0.90, color="green", linetype="dashed") +
    geom_hline(yintercept=0.80, color="orange", linetype="dashed") +
    geom_hline(yintercept=0.70, color="red", linetype="dashed") +
    xlab("Samples") +
    ylab("Haplogroup Quality") +
    theme(axis.text.x=element_text(angle=+90))
)
```



---

# About

Row
-------------------------------------

### About this report

This software was developed at the [Institute of Genetic Epidemiology](https://genepi.i-med.ac.at/), [Medical University of Innsbruck](https://i-med.ac.at/)

![](https://avatars2.githubusercontent.com/u/210220?s=30) [Lukas Forer](mailto:lukas.forer@i-med.ac.at) ([@lukfor](https://twitter.com/lukfor))

![](https://avatars2.githubusercontent.com/u/1931865?s=30) [Hansi Weissensteiner](mailto:hansi.weissensteiner@i-med.ac.at) ([@whansi](https://twitter.com/whansi))

![](https://avatars2.githubusercontent.com/u/1942824?s=30) [Sebastian Schoenherr](mailto:sebastian.schoenherr@i-med.ac.at) ([@seppinho](https://twitter.com/seppinho))

Row
-------------------------------------

### Workflow parameters and Software versions

```{r echo=FALSE, results='asis'}
pipeline_params %>%
  kable()
```
